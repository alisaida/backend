version: '3.9'
services:
  rabbitmq:
    hostname: rabbitmq
    image: 'rabbitmq:3.9-management-alpine'
    ports:
      - '5672:5672'
      - '15672:15672'
    environment:
      AMQP_URL: 'amqp://rabbitmq?connection_attempts=5&retry_delay=5'
      RABBITMQ_DEFAULT_USER: "guest"
      RABBITMQ_DEFAULT_PASS: "guest"
    networks:
      - backend_network
  redis-server:
    image: 'redis'
    networks:
      - backend_network
  nginx:
    image: nginx
    volumes:
      - ./nginx/default.conf:/etc/nginx/conf.d/default.conf:ro
    ports:
      - "5000:80"
    depends_on:
      - auth
      - chat
      - profile
      - post
    networks:
      - backend_network
  auth:
    build:
      context: ./auth
    environment:
      - SERVICE_NAME=auth
      - NODE_ENV=staging
      - REDIS_HOST=redis-server
      - AMQP_URL=amqp://guest:guest@rabbitmq:5672
    volumes:
      - ./auth/:/usr/src/app
      - /usr/src/app/node_modules
    depends_on:
      - rabbitmq
      - redis-server
    links: 
      - rabbitmq
    networks:
      - backend_network
  chat:
    build:
      context: ./chat
    environment:
      - SERVICE_NAME=chat
      - NODE_ENV=staging
      - AMQP_URL=amqp://guest:guest@rabbitmq:5672
    volumes:
      - ./chat/:/usr/src/app
      - /usr/src/app/node_modules
    depends_on:
      - rabbitmq
    links: 
      - rabbitmq
    networks:
      - backend_network
  profile:
    build:
      context: ./profile
    environment:
      - SERVICE_NAME=profile
      - NODE_ENV=staging
      - AMQP_URL=amqp://guest:guest@rabbitmq:5672
    volumes:
      - ./profile/:/usr/src/app
      - /usr/src/app/node_modules
    depends_on:
      - rabbitmq
    links: 
      - rabbitmq
    networks:
      - backend_network   
  post:
    build:
      context: ./post
    environment:
      - SERVICE_NAME=post
      - NODE_ENV=staging
      - AMQP_URL=amqp://guest:guest@rabbitmq:5672
    volumes:
      - ./post/:/usr/src/app
      - /usr/src/app/node_modules
    depends_on:
      - rabbitmq
    links: 
      - rabbitmq
    networks:
      - backend_network
  # # mail service    
  # mail:
  #   build:
  #     context: ./mail
  #   environment:
  #     - NODE_ENV=mail-service
  #     # - REDIS_HOST=redis-server
  #     - AMQP_URL=amqp://guest:guest@rabbitmq:5672
  #   volumes:
  #     - ./mail/:/usr/src/app
  #     - /usr/src/app/node_modules
  #   depends_on:
  #     - rabbitmq
  #     # - redis-server
  #   links: 
  #     - rabbitmq
  #   networks:
  #     - backend_network
networks:
  backend_network:
    driver: bridge